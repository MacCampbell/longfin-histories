---
title: "201-basic-gwas"
output: html_document
date: "2025-07-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```



```{r}
library(tidyverse)
library(RColorBrewer)
```

Basic ANGSD GWAS using HS and LS fish on DSM genome. Then we can try a kmer based approached. 

```{r}
m37<-read_csv("meta/m37.csv")
m37 %>% select(Path) %>% write_tsv(col_names=FALSE, file="bamlists/37.bamlist")
m37 %>% select(ybin) %>% write_tsv(col_names=FALSE, file="bamlists/37.pheno")
```

create null example by randomly generating 0 or 1
```{r, eval=FALSE}
rand<-sample(0:1,37, replace=T) 
m37$Rand<-rand 
m37 %>% select(Rand) %>% write_tsv(col_names=FALSE, file="bamlists/37.rand")
```

removing -rf outputs/101/chrom-regions.txt and redoing 
```{sh, eval=FALSE}
 srun -p med -t 10:00:00 --mem=64G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 \
 $HOME/angsd/angsd -P 12 -doAsso 1 -doPost 1 -yBin bamlists/37.pheno \
 -GL 1 -nThreads 12 -minInd 18 \
 -minMapQ 10 -minQ 20 -minMaf 0.05 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/201/do-asso \
  -bam bamlists/37.bamlist > outputs/201/do-asso.out 2> outputs/201/do-asso.err &

#randomized scores  
srun -p med -t 10:00:00 --mem=64G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 \
 $HOME/angsd/angsd -P 12 -doAsso 1 -doPost 1 -yBin bamlists/37.rand \
 -GL 1 -nThreads 12 -minInd 18 \
 -minMapQ 10 -minQ 20 -minMaf 0.05 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/201/do-asso-rand \
  -bam bamlists/37.bamlist > outputs/201/do-asso-rand.out 2> outputs/201/do-asso-rand.err &
```

	-> Number of sites retained after filtering: 62429 with chroms only
		-> Number of sites retained after filtering: 74667 with all seqs


```{r}
data<-read_tsv("outputs/201/do-asso.lrt0.gz")
```

```{r}
df <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p>=0 & log10p != "Inf") %>%
  mutate(p = dchisq(LRT, df=1)) %>%
  mutate(bonfer = p.adjust(p, method = "bonferroni")) %>% 
  mutate(BHfdr = p.adjust(p, method = "BH")) %>%
  group_by(Chromosome) %>%
  mutate(adjpchrom = p.adjust(p, method = "bonferroni")) %>%
  mutate(BHfdrchrom = p.adjust(p, method = "BH"))

dfs<-df %>% arrange(-LRT) %>% head(n=20)
dfs
```

```{r}
nb.cols <- length(unique(df$Chromosome))
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)
#randomize
mycolors<-sample(mycolors)
```

```{r}
ggplot(df %>% filter(Chromosome %in% unique(dfs$Chromosome))) +
  geom_point(aes(x=Position, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
  geom_hline(yintercept= 4, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("HS vs LS") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
  facet_wrap(.~Chromosome, ncol = 5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

ggsave("outputs/200/longfin-HS-LS-gwas.pdf")
```

## random phenos

74678 
```{r}
data<-read_tsv("outputs/201/do-asso-rand.lrt0.gz")
```

```{r}
df <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p>=0 & log10p != "Inf") %>%
  mutate(p = dchisq(LRT, df=1)) %>%
  mutate(bonfer = p.adjust(p, method = "bonferroni")) %>% 
  mutate(BHfdr = p.adjust(p, method = "BH")) %>%
  group_by(Chromosome) %>%
  mutate(adjpchrom = p.adjust(p, method = "bonferroni")) %>%
  mutate(BHfdrchrom = p.adjust(p, method = "BH"))

dfs<-df %>% arrange(-LRT) %>% head(n=20)
dfs
```

```{r}
nb.cols <- length(unique(df$Chromosome))
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)
#randomize
mycolors<-sample(mycolors)
```

```{r}
ggplot(df %>% filter(Chromosome %in% unique(dfs$Chromosome))) +
  geom_point(aes(x=Position, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
  geom_hline(yintercept= 4, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("HS vs LS") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
  facet_wrap(.~Chromosome, ncol = 5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

ggsave("outputs/200/longfin-HS-LS-rand.pdf")
```



## What about the other two phenos?

```{r}
m200<-read_csv("meta/m200.csv")
m200 %>% group_by(clust_name_100) %>% summarize(Count=n())
```

HS vs LS (done)
HS vs MS 26 fish
MS vs LS 30

```{r}
hm<-m200 %>% filter(clust_name_100 %in% c("HS","MS")) 
hm %>% select(Path) %>% write_tsv(col_names=FALSE, file="bamlists/hm26.bamlist")
hm %>% mutate(ybin=ifelse(clust_name_100=="HS",0,1)) %>% select(ybin) %>% write_tsv(col_names=FALSE, file="bamlists/hm26.pheno")

lm<-m200 %>% filter(clust_name_100 %in% c("LS","MS")) 
lm %>% select(Path) %>% write_tsv(col_names=FALSE, file="bamlists/lm30.bamlist")
lm %>% mutate(ybin=ifelse(clust_name_100=="LS",0,1)) %>% select(ybin) %>% write_tsv(col_names=FALSE, file="bamlists/lm30.pheno")
```



```{sh, eval=FALSE}
 srun -p high -t 4:00:00 --mem=64G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 \
 $HOME/angsd/angsd -P 12 -doAsso 1 -doPost 1 -yBin bamlists/hm26.pheno \
 -GL 1 -nThreads 12 -minInd 13 \
 -minMapQ 10 -minQ 20 -minMaf 0.05 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/201/do-asso-hm \
  -bam bamlists/hm26.bamlist > outputs/201/do-asso-hm.out 2> outputs/201/do-asso-hm.err &
  
srun -p high -t 4:00:00 --mem=64G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 \
 $HOME/angsd/angsd -P 12 -doAsso 1 -doPost 1 -yBin bamlists/lm30.pheno \
 -GL 1 -nThreads 12 -minInd 15 \
 -minMapQ 10 -minQ 20 -minMaf 0.05 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/201/do-asso-lm \
  -bam bamlists/lm30.bamlist > outputs/201/do-asso-lm.out 2> outputs/201/do-asso-lm.err &

```

(base) maccamp@farm:~/longfin-histories/outputs/201$ gunzip -c do-asso-hm.lrt0.gz  | sort -n -k 6 | tail
lcl|scaffold_11	4780263	C	T	0.254976	14.715204
lcl|scaffold_6	12592522	G	T	0.178177	14.734411
lcl|scaffold_4	17278636	T	A	0.198278	15.100863
lcl|scaffold_21	14360601	C	A	0.273048	16.003798
lcl|scaffold_3	2961157	G	C	0.392491	16.218962
lcl|scaffold_15	10908589	T	C	0.409366	16.427263
lcl|scaffold_10	10245629	C	T	0.375708	17.048462
lcl|scaffold_5	21402014	T	C	0.222451	17.698836
lcl|scaffold_35	1085839	T	G	0.475804	17.733960
lcl|scaffold_8	5713096	T	G	0.220196	18.144262

ase) maccamp@farm:~/longfin-histories/outputs/201$ gunzip -c do-asso-lm.lrt0.gz  | sort -n -k 6 | tail
lcl|scaffold_177	65249	G	A	0.201322	14.225899
lcl|scaffold_137	11790	A	G	0.184370	14.463646
lcl|scaffold_2	7076913	C	T	0.136348	14.549636
lcl|scaffold_18	2734141	G	A	0.271149	14.717956
lcl|scaffold_13	1844224	A	G	0.470526	14.773842
lcl|scaffold_8	9032867	T	C	0.277918	14.904999
lcl|scaffold_13	1844210	G	A	0.100926	15.171099
lcl|scaffold_11	12767195	C	A	0.135324	16.424976
lcl|scaffold_3	11955169	A	C	0.283033	17.124473
lcl|scaffold_321	35814	A	G	0.187799	18.887605

(base) maccamp@farm:~/longfin-histories/outputs/201$ gunzip -c do-asso.lrt0.gz  | sort -n -k 6 | tail
lcl|scaffold_1	13190054	A	G	0.126897	15.419654
lcl|scaffold_19	9609023	T	A	0.188727	15.422207
lcl|scaffold_14	2068807	A	G	0.217303	15.471566
lcl|scaffold_22	7127011	T	G	0.202647	15.651682
lcl|scaffold_22	7127030	G	C	0.202942	15.681280
lcl|scaffold_17	3006497	T	C	0.159525	15.819333
lcl|scaffold_27	6664026	C	T	0.139077	15.873745
lcl|scaffold_9	11143286	A	C	0.399098	16.210282
lcl|scaffold_9	3534840	A	G	0.285408	16.259896
lcl|scaffold_26	1383166	C	T	0.193978	18.457351
