---
title: "101-data"
output: html_document
date: "2024-10-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
```

wget -np -r --cut-dirs 3 http://slimsdata.genomecenter.ucdavis.edu/Data/izi9cfibu/Un_DTSA984/Project_AFSP_LONGFIN_RAD/

Two plates of data, putting in data/raw

Have demultiplexed.   

`/home/maccamp/longfin-histories/data/raw/plate-1`    
`/home/maccamp/longfin-histories/data/raw/plate-2`    

```{r}
m1<-read_csv("meta/samples-10312024.csv") %>% mutate(Well=paste0(Row,Column)) %>% select(-Row, -Column)
barcodes<-read_csv("meta/expected-barcodes.csv")
m1<-m1 %>% left_join(barcodes) 
```

Samples are of the form:
PLATE01_RA_GGAAACATCGTGCAGG.fastq

```{r}
p1<-m1 %>% filter(Plate==1) %>% mutate(File1=paste0("PLATE0",Plate,"_RA_GG",Barcode,"TGCAGG.fastq")) %>%
  mutate(File2=paste0("PLATE0",Plate,"_RB_GG",Barcode,"TGCAGG.fastq")) %>%
  mutate(File3=paste0(SampleID,"_R1.fastq")) %>%
  mutate(File4=paste0(SampleID,"_R2.fastq")) %>%
  mutate(Command1 = paste0("mv data/raw/plate-1/", File1, " data/renamed/",File3)) %>%
  mutate(Command2 = paste0("mv data/raw/plate-1/", File2, " data/renamed/",File4)) 
p2<-m1 %>% filter(Plate==2) %>% mutate(File1=paste0("PLATE0",Plate,"_RA_GG",Barcode,"TGCAGG.fastq")) %>%
  mutate(File2=paste0("PLATE0",Plate,"_RB_GG",Barcode,"TGCAGG.fastq")) %>%
  mutate(File3=paste0(SampleID,"_R1.fastq")) %>%
  mutate(File4=paste0(SampleID,"_R2.fastq")) %>%
  mutate(Command1 = paste0("mv data/raw/plate-2/", File1, " data/renamed/",File3)) %>%
  mutate(Command2 = paste0("mv data/raw/plate-2/", File2, " data/renamed/",File4)) 

c1<-p1%>%select(Command1) %>% rename(Command=Command1)
c2<-p1%>%select(Command2) %>% rename(Command=Command2)
c3<-p2%>%select(Command1) %>% rename(Command=Command1)
c4<-p2%>%select(Command2) %>% rename(Command=Command2)
bind_rows(c1,c2,c3,c4) %>% write_tsv("101.1-rename-commands.txt", col_names = FALSE)
```


For comparison:
/home/skieran/lfs/raw/mac_ototyped$ 

ls -al /home/skieran/lfs/raw/mac_ototyped | awk '{ if ($5 >= 40) print }' | grep R1 | wc -l
26

```{r}
fish<-read_csv("Longfin smelt meta and tissues/all_fish_clust_ids.csv") 
fish$SampleID<-gsub("_0","",fish$fishid)
fish$SampleID<-gsub("_","",fish$SampleID)
```

```{r}
m2<-m1 %>% left_join(fish) 
m2 %>% group_by(clust_name_100) %>% summarize(Count=n())
```

I think what would be a good thing to do is sequence all of clusters 1, 2, 3 and a randomized subset of cluster 4 (n ~ 25) to represent that.  In that way we can model the transition timing (clusters 1,2,3) and the brackish water residency (discrete, clusters 1,2,3 vs 4).


# Do align

 GCF_021917145.1_fHypTra1_genomic.fna in data/dsm-align
 `bash ../../101.2-do-align.sh to-align.txt /home/maccamp/genomes/GCF021917145.1/GCF_021917145.1_fHypTra1_genomic.fna`
 Also trying Shannon's individuals in data/alt-demultiplexed

Presumably, it'll be fine. Running against `bash ../../101.2-do-align.sh to-align.txt /home/maccamp/longfin-histories/genomes/denovo-genome/lfs_draft_assembly.fastq.gz`    

## Check metrics 
```{r}
df<-read_csv("meta/alt-demulti.txt", col_names = c("SampleID","Aligned","Dedup","Cov"))
ddf<-m2 %>% left_join(df) %>% mutate(Path=paste0("data/alt-demultiplexed/",SampleID,".sort.flt.bam"))
```


```{r}
ggplot(ddf) +
  geom_histogram(aes(x=Dedup)) +
  theme_bw() +
  theme(panel.grid=element_blank()) +
  ylab("Count")
```

```{r}
m100<-ddf %>% filter(Dedup>1e5) 
m100 %>% group_by(clust_name_100) %>% summarize(Count=n())
m100 %>% select(Path) %>% write_tsv(col_names = FALSE, file="bamlists/49.bamlist")
```

49 samples   

Lets quickly generate a covariance matrix.
```{sh,, eval=FALSE}
srun -p high -t 10:00:00 --mem=64G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12  $HOME/angsd/angsd -P 12  \
-bam bamlists/49.bamlist -ref /home/maccamp/genomes/GCF021917145.1/GCF_021917145.1_fHypTra1_genomic.fna \
-minInd 37 -minMapQ 10 -minQ 20 -GL 2 -doGLF 2 \
-doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doIBS 1 -doCounts 1 -doCov 1 -makeMatrix 1 -minMaf 0.05 \
-out outputs/101/m100-ibs-75 >outputs/101/m100-ibs-75.out 2> outputs/101/m100-ibs-75.err &
```

