---
title: "212-subtraction"
output: html_document
date: "2025-10-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(pheatmap)
library(ggplotify)
library(RColorBrewer)

```


```{r}
fish<-read_tsv("outputs/210/m80-ordered.bamlist", col_names = c("Path"))
fish$Sample<-gsub("/home/maccamp/dsm-omics/data/SOMM51\\d/","",fish$Path)
fish$Sample<-gsub("_R1.sort.flt.bam","",fish$Sample)
fish$Sex<-gsub("^\\d\\d\\d\\d\\d","",fish$Sample)
fish$Sex<-as.numeric(fish$Sex)
fish<-fish %>% relocate(Sample, Sex, Path)
fish %>% select(Sample) %>% write_tsv("bamlists/test80.names", col_names = FALSE)
fish %>% select(Path) %>% write_tsv("bamlists/test80.bamlist", col_names = FALSE)
fish
```


Let's look at unaligned and male specific sequence

annot$Sex<-gsub("1","Female",annot$Sex)
annot$Sex<-gsub("2","Male",annot$Sex)

https://pmc.ncbi.nlm.nih.gov/articles/PMC11481317/

_1_ Identify the highest coverage 10 females and 10 males (and omit ones Mac finds suspicious)
_2_ Extract unaligned sequences from males/females
_3_ De novo asssemble unaligned male data, SPADES (?)
_4_ Realign unaligned male/female data to de denovo assembly
_5_ Separate male specific contigs as candidate sex markers
_6_ Use other sequences to verify male specificity (not from the original 10 highest coverage)

samtools flagstat 121922_R1.sort.bam 87140918 + 0 mapped (92.27% : N/A)
samtools flagstat 401432_R1.sort.bam 80013837 + 0 mapped (93.39% : N/A)

samtools flagstat 110611_R1.sort.bam 56403988 + 0 mapped (93.22% : N/A)
samtools flagstat 110381_R1.sort.bam 79366019 + 0 mapped (92.58% : N/A)


New curated genome in 
(base) maccamp@farm:~/genomes/hypomesus-curated$

Checking busco 
conda activate busco

srun -p high -t 6:00:00 --mem=32GB --nodes=1 --cpus-per-task=12 busco -i fHypTra1.pri.cur.20251017.fasta -o busco -m genome -l actinopterygii_odb12 --cpu 12 --skip_bbtools

 -------------------------------------------------------------------------------------------
    |Results from dataset actinopterygii_odb12                                                 |
    -------------------------------------------------------------------------------------------
    |C:96.4%[S:95.5%,D:0.9%],F:1.2%,M:2.4%,n:7207,E:5.2%                                       |
    |6949    Complete BUSCOs (C)    (of which 359 contain internal stop codons)                |
    |6886    Complete and single-copy BUSCOs (S)                                               |
    |63    Complete and duplicated BUSCOs (D)                                                  |
    |88    Fragmented BUSCOs (F)                                                               |
    |170    Missing BUSCOs (M)                                                                 |
    |7207    Total BUSCO groups searched                                                       |
    -------------------------------------------------------------------------------------------
20


We can link fish data in ./data/sub
```{r}
fish$Link<-gsub("1.sort.flt.bam","",fish$Path) 
fish %>% select(Link) %>% write_tsv("outputs/212/link.tsv")
#linking in all files
```

Set up names to work with 101.2-do-align.sh

bash ../../101.2-do-align.sh to-align.txt /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta


We'll compare our alignment success rate to these ones

samtools flagstat 121922.sort.bam 91682741 + 0 mapped (97.01% : N/A)
samtools flagstat 401432.sort.bam 83569992 + 0 mapped (97.45% : N/A)
samtools flagstat 110611.sort.bam 58969314 + 0 mapped (97.41% : N/A)
samtools flagstat 110381.sort.bam 83330826 + 0 mapped (97.15% : N/A)

Then we can rerun our sex gwas
'first two digits is a generation number, the three in the middle is a cross number, and the last number is for male/ female (1 or 2)."
```{r}
m80<-fish %>% select(-Path, -Link) %>% mutate(Pheno=Sex-1) %>% mutate(SexChar=ifelse(Sex==2, "Male","Female")) %>% mutate(Path=paste0("/home/maccamp/longfin-histories/data/sub/",Sample,".sort.flt.bam"))
m80 %>% select(Pheno) %>% write_tsv("bamlists/80.pheno", col_names = FALSE)
m80 %>% select(Path) %>% write_tsv("bamlists/80.bamlist", col_names = FALSE)
m80 %>% select(Sample) %>% write_tsv("bamlists/80.names", col_names=FALSE)
m80 %>% filter(SexChar=="Female") %>% select(Sample) %>% write_tsv("bamlists/80-females.names", col_names=FALSE)
m80 %>% filter(SexChar=="Male") %>% select(Sample) %>% write_tsv("bamlists/80-males.names", col_names=FALSE)


#bind on data
dat<- read_csv("outputs/212/curated.dat", col_names = c("Sample","Sort","Dedup","Cov"))
dat$Sample<-as.character(dat$Sample)
nm<-left_join(m80,dat)
topc<-nm %>% group_by(SexChar) %>% top_n(10, Cov)
write_csv(nm, file="meta/nm.csv")
```

no -rf -rf meta/lates-lgs.txt
```{sh, eval=FALSE}
srun -t 72:00:00 -p high --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -P 12 \
 -doAsso 1 -yBin $HOME/longfin-histories/bamlists/80.pheno -GL 1 -minInd 76 -minMaf 0.10 \
 -minMapQ 20 -minQ 20 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/212/asso-95 \
 -bam $HOME/longfin-histories/bamlists/80.bamlist  > outputs/212/asso.out 2> outputs/212/asso.err &
 
 srun -t 72:00:00 -p high --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -P 12 \
 -doAsso 1 -yBin $HOME/longfin-histories/bamlists/80.pheno -GL 1 -minInd 60 -minMaf 0.10 \
 -minMapQ 20 -minQ 20 \
 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 -out outputs/212/asso-75 \
 -bam $HOME/longfin-histories/bamlists/80.bamlist  > outputs/212/asso-75.out 2> outputs/212/asso-75.err &
```

```{r}
files = list.files(path="outputs/212/", pattern="*75.lrt0.gz", full.names = TRUE)
list = lapply(files, read_tsv)
data<-bind_rows(list)
```

```{r}
df <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p>=0 & log10p != "Inf") %>%
  mutate(p = dchisq(LRT, df=1)) %>%
  mutate(bonfer = p.adjust(p, method = "bonferroni")) %>% 
  mutate(BHfdr = p.adjust(p, method = "BH")) %>%
  group_by(Chromosome) %>%
  mutate(adjpchrom = p.adjust(p, method = "bonferroni")) %>%
  mutate(BHfdrchrom = p.adjust(p, method = "BH")) %>% ungroup() %>%
  mutate(Index=1:n())

df %>% arrange(-LRT) %>% head(n=20)
```

75%
	-> Number of sites retained after filtering: 1242834 
95%
	-> Number of sites retained after filtering: 1136385 
```{r}
df %>% filter(Chromosome!="SUPER_10") %>% arrange(-LRT) %>% head(n=20)
```

```{r}
#c("SUPER_1","SUPER_10","SUPER_11","Scaffold_120","SUPER_3","Scaffold_129","SUPER_8")
ggplot(df %>% filter(Chromosome %in% c("SUPER_1","SUPER_10","SUPER_11","SUPER_4"))) +
  geom_point(aes(x=Position, y=log10p)) +
  facet_wrap(.~Chromosome, scales="free_x") +
  theme_bw() +
  theme(panel.grid=element_blank()) +
  ylab("-log10 (p-value)\n") +
  xlab("\n Position") 
ggsave("outputs/212/sex-gwas-curated-genome.jpeg")
```

```{r}
sub<-df %>% arrange(-LRT) %>% filter(Chromosome=="SUPER_10") %>% head(n=80) %>% arrange(Position)
ggplot(sub) +
  geom_point(aes(x=Position, y=log10p))
sub %>% select(Chromosome, Position) %>% write_tsv("meta/212-sites.tsv", col_names = FALSE)

sub2<-df %>% arrange(-LRT) %>% filter(Chromosome=="SUPER_10") %>% head(n=250) %>% arrange(Position)
ggplot(sub2) +
  geom_point(aes(x=Position, y=log10p))
sub2 %>% select(Chromosome, Position) %>% write_tsv("meta/212-sites2.tsv", col_names = FALSE)

```

Manhattan plot

```{r}
d2<-df %>% filter(Chromosome %in% c("SUPER_1","SUPER_2","SUPER_3","SUPER_4","SUPER_5","SUPER_6","SUPER_7","SUPER_8","SUPER_9","SUPER_10","SUPER_11","SUPER_12","SUPER_13","SUPER_14","SUPER_15","SUPER_16","SUPER_17","SUPER_18","SUPER_19","SUPER_20","SUPER_21","SUPER_22","SUPER_23","SUPER_24","SUPER_25","SUPER_26","SUPER_27","SUPER_28"))
d2$Chromosome<-factor(d2$Chromosome,levels=c("SUPER_1","SUPER_2","SUPER_3","SUPER_4","SUPER_5","SUPER_6","SUPER_7","SUPER_8","SUPER_9","SUPER_10","SUPER_11","SUPER_12","SUPER_13","SUPER_14","SUPER_15","SUPER_16","SUPER_17","SUPER_18","SUPER_19","SUPER_20","SUPER_21","SUPER_22","SUPER_23","SUPER_24","SUPER_25","SUPER_26","SUPER_27","SUPER_28"))
nb.cols <- length(unique(d2$Chromosome))
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)


chroms<-d2 %>% group_by(Chromosome) %>% mutate(Start=min(Index), Stop=max(Index)) %>% 
  dplyr::select(Chromosome,Start,Stop) %>% unique() %>% 
  mutate(Position=round((Start+Stop)/2))

ggplot(d2) +
  geom_point(data=d2, aes(x=Index, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
#  geom_point(data=outliers, aes(x=Index, y=log10p), color="black", cex=0.5, alpha=0.9) +
 # geom_hline(yintercept = 5.9, lty=2, alpha=0.6) +
  #geom_hline(yintercept = 5, lty=2, alpha=0.6) +
  theme_bw() +
  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=6)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)") +
  xlab("Chromosome") +
  ggtitle("Sex GWAS in Delta Smelt") +
  theme(plot.title = element_text(hjust=0.5) )

ggsave("outputs/212/sex-gwas-delta-smelt.pdf", width=6, height=3)
ggsave("outputs/212/sex-gwas-delta-smelt.jpeg", width=6, height=3)

```




```{sh, eval=FALSE}
srun -t 2:00:00 -p high --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 72 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-r SUPER_10:16000000- -sites outputs/212/212-sites.tsv -out outputs/212/snps \
-minMaf 0.05 -minMapQ 20 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doGeno 2 -doPost 1 -postCutoff 0.95 -doPlink 2  > outputs/212/snps.out 2> outputs/212/snps.err &

#57 sites called

srun -t 2:00:00 -p high --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 60 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-r SUPER_10:16000000- -sites outputs/212/212-sites.tsv -out outputs/212/snps-relaxed \
-minMaf 0.05 -minMapQ 10 -minQ 10 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-5 -doGlf	2 \
-doGeno 2 -doPost 1 -postCutoff 0.80 -doPlink 2  > outputs/212/snps-relaxed.out 2> outputs/212/snps-relaxed.err &

#	-> Number of sites retained after filtering: 66  (not including top3 sites)
#	-> Number of sites retained after filtering: 75  (when -postCutoff 80)

#sites2 called across  all sites at the end of the chrom
srun -t 2:00:00 -p bigmemm --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 72 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-r SUPER_10:15000000- -out outputs/212/snps2 \
-minMaf 0.10 -minMapQ 20 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doGeno 2 -doPost 1 -postCutoff 0.95 -doPlink 2  > outputs/212/snps2.out 2> outputs/212/snps2.err &

#scaffold_120
srun -t 2:00:00 -p bigmemm --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 60 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-r Scaffold_120 -out outputs/212/scaffold_120 -doGlf	2 \
-minMaf 0.10 -minMapQ 10 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-5 \
-doGeno 2 -doPost 1 -postCutoff 0.8 -doPlink 2  > outputs/212/snps120.out 2> outputs/212/snps120.err &

#	-> Number of sites retained after filtering: 11 
#	-> Number of sites retained after filtering: 59 with relaxed version

#sites called across  all sites 

srun -t 48:00:00 -p bigmemm --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 72 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-out outputs/212/snps-all \
-minMaf 0.10 -minMapQ 20 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doGeno 2 -doPost 1 -postCutoff 0.95 -doPlink 2  > outputs/212/snps-all.out 2> outputs/212/snps-all.err &

srun -t 48:00:00 -p bigmemm --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 72 -bam $HOME/longfin-histories/bamlists/80.bamlist -ref /home/maccamp/genomes/hypomesus-curated/fHypTra1.pri.cur.20251017.fasta  \
-out outputs/212/snps-05 \
-minMaf 0.05 -minMapQ 20 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doGeno 2 -doPost 1 -postCutoff 0.95 -doPlink 2  > outputs/212/snps-05.out 2> outputs/212/snps-05.err &

```

Top 3 sites
SUPER_10   16495263
SUPER_10   17774598
SUPER_10   16577582
-doGlf	2

```{r}
meta<-fish
ddf<-read_tsv("outputs/212/snps.geno.gz", col_names = c("FALSE")) %>% select(-X83)
#replace with most commmon entry?
#replace with NA for now
ddf[ddf==-1]<-NA
ddf2<-ddf
#ddf2<-ddf %>% filter(X2 %in% head(sub$Position,30))
m<-ddf2 %>% select(-`FALSE`, -X2) %>% as.matrix()

annot<-data.frame(sample=as.character(colnames(m))) %>% column_to_rownames("sample")

annot$Sex<-meta$Sex
annot$Sex<-gsub("1","Female",annot$Sex)
annot$Sex<-gsub("2","Male",annot$Sex)
annot$Coverage<-nm$Cov
```

```{r}

as.ggplot(pheatmap(m, labels_col = meta$Sample, cluster_rows=TRUE, annotation_col = annot, width=12, height=8, cluster_cols = FALSE, legend=TRUE,
                   labels_row = ddf$X2,
         fontsize_col = 6)) + ggtitle("Delta Smelt Variants on Delta Smelt SUPER_10") +
  theme(plot.title = element_text(hjust=0.5))
ggsave("outputs/212/dsm-sex-dsm-reference-heatmap-subset.pdf", width=12, height=8)
```

topc?



(base) maccamp@farm:~/longfin-histories/outputs/212$ grep 161873 scaffold_120.tped 
Scaffold_120 Scaffold_120_161873 0 161873	T T	0 0	T T	T A	T T	T T	T T	T T	T T	0 0	0 0	0 0	0 0	T T	T T	T T	T T	T A	T T	T T	T A	T T	T T	0 0	T T	T A	T T	T T	T T	T T	T T	T T	T T	T T	T A	T T	0 0	T T	T T	0 0	0 0	T A	T T	T A	T A	T A	A A	T T	T T	T T	T T	0 0	T A	T A	T A	0 0	T A	0 0	T T	T A	T T	T T	0 0	A A	0 0	A A	A A	T A	0 0	T T	0 0	T A	0 0	T A	T A	A A	0 0	T T	T A	0 0


Can I calculater an AF difference of
0.0 - 0.5 = 0.5?


plink --tped snps2.tped --tfam snps2.tfam  --out plink-binary --recode --allow-extra-chr --noweb
plink --ped plink-binary.ped --map plink-binary.map --recode vcf --allow-extra-chr -out plink
bgzip plink.vcf 
tabix plink.vcf.gz
bcftools reheader --samples meta/80.names outputs/212/plink.vcf.gz | bcftools +fill-tags -- -t MAF > outputs/212/renamed.vcf
bcftools view -s bamlists/80-females.names outputs/212/renamed.vcf | bcftools +fill-tags -- -t MAF > outputs/212/female.vcf
bcftools view -s bamlists/80-males.names outputs/212/renamed.vcf | bcftools +fill-tags -- -t MAF > outputs/212/male.vcf


#renaming vcf with sample names, filtering again on MAF, and then pruning, selecting random SNP

module load bcftools/1.13

#Basically, pruning before was like this: bcftools +prune -l 0.20 -w 10000



Could split into separate VCFs then calculater freqs with bcftools and remerge (but watch for changing reference allele)
_1_ Identify the highest coverage 10 females and 10 males (and omit ones Mac finds suspicious)
These may be ones that don't track with markers id'd by gwas

Which ones are these?

Unlikely females

901071
701931
902671

Unlikely males
121922
401432
402282
500742
602392
300662
302002
400282
402592
501802
600902
600872
600772
602992
701932
701782
110382

Is there low coverage and a bias towards homozygosity here??





_2_ Extract unaligned sequences from males/females

(can try chrom by chrom pc)

samtools view -b -f 4 file.bam > unmapped.bam
samtools view -b -f 8 file.bam > unmapped.bam # both read1 and read2 unmapped
using the sort.bam files

```{r}
topc %>% ungroup() %>% mutate(Command=paste0("samtools view -b -f 12 /home/maccamp/longfin-histories/data/sub/",Sample,".sort.bam > ",
                              "/home/maccamp/longfin-histories/data/unmapped/",Sample,".bam; samtools collate -u -O /home/maccamp/longfin-histories/data/unmapped/",Sample,".bam | samtools fastq -1 /home/maccamp/longfin-histories/data/unmapped/",Sample,"-r1.fastq -2 /home/maccamp/longfin-histories/data/unmapped/",Sample,"-r2.fastq")) %>%
  select(Command) %>% write_tsv("212.1-unmapped-commands.tsv", col_names = FALSE)

topc %>% ungroup() %>% mutate(Command=paste0("flash data/unmapped/",Sample,"-r1.fastq  data/unmapped/",Sample,"-r2.fastq -o data/unmapped/",Sample,"-flash --max-overlap 120 --min-overlap 20"))  %>%
  select(Command) %>% write_tsv("212.2-flash.tsv", col_names = FALSE)

                              
```


Let's identify from topc some candidate males.
-> not 121922, 402282, 300662

Candidate males
600232, 901522, 901232, 120092

less good candidate
601512, 700232

Let's identify from topc some candidate females
-not 701931

Candidate females
400281, 401261, 500131, 701331, 700901, 801931, 802601

less good candidate
402281

module load parallel
srun -p high --time 4:00:00 --nodes=1 --ntasks-per-node=1 --cpus-per-task=11 parallel -j 11 < 212.1-unmapped-commands.tsv
(this command isn't working for whatever reason)


samtools flagstat 110381.bam (with -f 12)
1889938 + 0 in total 
1889938 + 0 paired in sequencing
944969 + 0 read1
944969 + 0 read2

samtools collate -u -O 110381.bam | samtools fastq -1 110381-r1.fastq -2 110381-r2.fastq

check for read through?


Let's repeat for all our fish, and use these candidate ones
600232, 901522, 901232, 120092
400281, 401261, 500131, 701331



```{sh, eval=FALSE}
#on farm in ~/longfin-histories
bash 212.2-flash.tsv
```

_3_ De novo asssemble unaligned male data, SPADES

erro   1:16:02.922  3668M / 5153M ERROR   General                 (hammer_tools.cpp          : 194)   Pair of read files "/home/maccamp/longfin-histories>

when back and redid with -f 12
[M::bam2fq_mainloop] discarded 0 singletons
[M::bam2fq_mainloop] processed 1889938 reads

Can cat together several individual fastq files 
600232, 901522, 901232, 120092


then run something like this:
```{sh, eval=FALSE}
srun -p bigmemm -t 48:00:00 --mem=256GB --nodes=1 --cpus-per-task=6 spades.py --phred-offset 33 -1 data/unmapped/110381-r1.fastq -2 data/unmapped/110381-r2.fastq -o data/unmapped/110381 > data/unmapped/110381.out 2> data/unmapped/110381.err & 

#Spades with unpaired
srun -p bigmemm -t 48:00:00 --mem=256GB --nodes=1 --cpus-per-task=6 spades.py --phred-offset 33 -1 data/unmapped/110381-flash.notCombined_1.fastq -2 data/unmapped/110381-flash.notCombined_2.fastq --merged data/unmapped/110381-flash.extendedFrags.fastq -o data/unmapped/110381-flash > data/unmapped/110381-flash.out 2> data/unmapped/110381-flash.err & 
````


combine, then assemble our candidate males

```{sh, eval=FALSE}
cat 600232-flash.notCombined_1.fastq 901522-flash.notCombined_1.fastq 901232-flash.notCombined_1.fastq 120092-flash.notCombined_1.fastq > male-r1.fastq
cat 600232-flash.notCombined_2.fastq 901522-flash.notCombined_2.fastq 901232-flash.notCombined_2.fastq 120092-flash.notCombined_2.fastq > male-r2.fastq
cat 600232-flash.extendedFrags.fastq 901522-flash.extendedFrags.fastq 901232-flash.extendedFrags.fastq 120092-flash.extendedFrags.fastq > male-extended.fastq
```

```{sh, eval=FALSE}
#Spades with unpaired
conda activate spades
srun -p bigmemm -t 48:00:00 --mem=256GB --nodes=1 --cpus-per-task=6 spades.py --phred-offset 33 -1 data/unmapped/male-r1.fastq -2 data/unmapped/male-r2.fastq --merged data/unmapped/male-extended.fastq -o data/unmapped/male-flash > data/unmapped/male-flash.out 2> data/unmapped/male-flash.err & 
````


Pretty similar assemblies
Comparing spades flashed/unflashed scaffolds
(base) maccamp@farm:~/longfin-histories/data/unmapped/110381$ assembledSeqStats.pl scaffolds.fasta 
Number of Contigs	29419
Total Bases	22325036
No. of Contigs >=1000	6685
Max Contig Length	15845

(base) maccamp@farm:~/longfin-histories/data/unmapped/110381-flash$ assembledSeqStats.pl scaffolds.fasta 
Number of Contigs	22714
Total Bases	20086919
No. of Contigs >=1000	6510
Max Contig Length	15845

For multiple fish, should I specify different libraries, or cat together reads?


I like the plan of assembly of 2 x 5 different males and 2 x 5 females and checking for concordance.

I assembled four candidate males using flashed reads and spades as one assembly.



aligning to/110381-flash scaffolds in data/110381-flash, indexing with bwa...
aligning to/110381 scaffolds in data/110381, indexing with bwa...

bash ../../101.2-do-align.sh to-align.txt /home/maccamp/longfin-histories/data/110381-flash/scaffolds.fasta
bash ../../101.2-do-align.sh to-align.txt /home/maccamp/longfin-histories/data/110381/scaffolds.fasta


making a directory to do this again

(base) maccamp@farm:~/longfin-histories/data/unmapped/male-flash$ assembledSeqStats.pl scaffolds.fasta 
Number of Contigs	21833
Total Bases	24825170
No. of Contigs >=1000	8529
Total Bases in Contigs >=1000	18312734
Mean Contig Length	1137.04804653506
Max Contig Length	16247
N50	1768
Number of Contigs in N50	4102
GC content	50.0237908471414
Proportion of Ns	0.00171318061467454

(base) maccamp@farm:~/longfin-histories/data/male-flash$ ln -s ../unmapped/male-flash/scaffolds.fasta .
(base) maccamp@farm:~/longfin-histories/data/male-flash$ bwa index scaffolds.fasta 

male-flash/scaffolds.fasta, linking over all our fish



bash ../../101.2-do-align.sh to-align.txt /home/maccamp/longfin-histories/data/male-flash/scaffolds.fasta



mosdepth, installing with bioconda

now to test across aligned files

--quantize 0:1:4:100:200: # ... arbitary number of quantize bins.

indicates bins of: 0:1, 1:4, 4:100, 100:200, 200:infinity where the upper endpoint is non-inclusive.
0:0:1:
--quantize 0:0:1:4:100:200 


These are our candidate fish though
600232, 901522, 901232, 120092
400281, 401261, 500131, 701331

```{sh, eval=FALSE}
#males
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 600232-depth 600232-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 901522-depth 901522-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 901232-depth 901232-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 120092-depth 120092-realign.sort.flt.bam

#females
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 400281-depth 400281-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 401261-depth 401261-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 500131-depth 500131-realign.sort.flt.bam
srun -p bigmemm --time=1:00 --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=2 mosdepth -Q 10 -n 701331-depth 701331-realign.sort.flt.bam


```

cat 400281-depth.mosdepth.summary.txt | awk ' $4 < 1 '
(base) maccamp@farm:~/longfin-histories/data/male-flash$ cat 400281-depth.mosdepth.summary.txt | awk ' $4 < .1 ' | sort -k 4 -n | head -n 20
NODE_13760_length_566_cov_2.611452      566     20      0.04    0       1
NODE_18033_length_373_cov_4.320946      373     19      0.05    0       1
NODE_15222_length_488_cov_3.652068      488     31      0.06    0       1
NODE_533_length_4345_cov_4.599813       4345    300     0.07    0       1
NODE_15178_length_490_cov_3.508475      490     39      0.08    0       1
NODE_15266_length_486_cov_2.122249      486     37      0.08    0       1
NODE_16673_length_424_cov_4.377522      424     33      0.08    0       1
NODE_16849_length_417_cov_3.132353      417     32      0.08    0       1
NODE_16869_length_416_cov_4.265487      416     32      0.08    0       1
NODE_17758_length_383_cov_3.470588      383     33      0.09    0       1
NODE_18278_length_364_cov_1.404181      364     32      0.09    0       1
NODE_18329_length_362_cov_3.080702      362     36      0.10    0       1
NODE_10813_length_780_cov_3.630156      780     94      0.12    0       2
NODE_17111_length_406_cov_5.848024      406     48      0.12    0       1
NODE_18081_length_371_cov_5.697279      371     54      0.15    0       1
NODE_17797_length_382_cov_3.304918      382     63      0.16    0       1
NODE_17964_length_376_cov_2.040134      376     62      0.16    0       2
NODE_15985_length_453_cov_1.545213      453     83      0.18    0       2
NODE_17042_length_409_cov_1.975904      409     73      0.18    0       1
NODE_18424_length_359_cov_1.780142      359     68      0.19    0       1

cat 401261-depth.mosdepth.summary.txt | awk ' $4 < 1 ' | sort -k 4 -n | head
(base) maccamp@farm:~/longfin-histories/data/male-flash$ cat 401261-depth.mosdepth.summary.txt | awk ' $4 < 1 ' | sort -k 4 -n | head -n 20
NODE_7698_length_1104_cov_3.323272      1104    21      0.02    0       1
NODE_10905_length_773_cov_3.748563      773     31      0.04    0       1
NODE_13520_length_580_cov_16.968191     580     36      0.06    0       1
NODE_13710_length_569_cov_1.036585      569     35      0.06    0       1
NODE_15178_length_490_cov_3.508475      490     32      0.07    0       1
NODE_15244_length_487_cov_2.851220      487     34      0.07    0       1
NODE_15247_length_487_cov_1.826829      487     35      0.07    0       1
NODE_16489_length_432_cov_4.591549      432     30      0.07    0       1
NODE_16869_length_416_cov_4.265487      416     32      0.08    0       1
NODE_17480_length_392_cov_1.342857      392     30      0.08    0       1
NODE_17508_length_391_cov_1.614650      391     30      0.08    0       1
NODE_17964_length_376_cov_2.040134      376     31      0.08    0       1
NODE_18039_length_373_cov_1.439189      373     30      0.08    0       1
NODE_18113_length_370_cov_2.378840      370     30      0.08    0       1
NODE_18161_length_368_cov_6.250859      368     30      0.08    0       1
NODE_17355_length_397_cov_1.343750      397     38      0.10    0       1
NODE_18131_length_369_cov_4.876712      369     37      0.10    0       1
NODE_17976_length_375_cov_6.983221      375     42      0.11    0       1
NODE_11370_length_733_cov_7.800305      733     89      0.12    0       1
NODE_15034_length_497_cov_1.157143      497     60      0.12    0       1

(base) maccamp@farm:~/longfin-histories/data/male-flash$ grep NODE_15178_length_490_cov_3.508475 *summary.txt
120092-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     754     1.54    0       5
400281-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     39      0.08    0       1
401261-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     32      0.07    0       1
500131-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     300     0.61    0       1
600232-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     32      0.07    0       1
701331-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     130     0.27    0       4
901522-depth.mosdepth.summary.txt:NODE_15178_length_490_cov_3.508475    490     931     1.90    0       3

(base) maccamp@farm:~/longfin-histories/data/male-flash$ grep NODE_17964_length_376_cov_2.040134 *summary.txt
120092-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     169     0.45    0       1
400281-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     62      0.16    0       2
401261-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     31      0.08    0       1
500131-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     244     0.65    0       2
600232-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     637     1.69    0       8
701331-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     612     1.63    0       7
901232-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     169     0.45    0       1
901522-depth.mosdepth.summary.txt:NODE_17964_length_376_cov_2.040134    376     420     1.12    0       3

cat 400281-depth.mosdepth.summary.txt | awk ' $4 < .1 ' | cut -f 1 | while read line; do echo $line; grep $line *summary.txt; done; 
cat 401261-depth.mosdepth.summary.txt | awk ' $4 < .1 ' | cut -f 1 | while read line; do echo $line; grep $line *summary.txt; done; 

Some options:
NODE_21382_length_87_cov_28.300000
120092-depth.mosdepth.summary.txt:NODE_21382_length_87_cov_28.300000	87	140	1.61	0	2
400281-depth.mosdepth.summary.txt:NODE_21382_length_87_cov_28.300000	87	0	0.00	0	0
600232-depth.mosdepth.summary.txt:NODE_21382_length_87_cov_28.300000	87	62	0.71	0	1
901232-depth.mosdepth.summary.txt:NODE_21382_length_87_cov_28.300000	87	37	0.43	0	1
901522-depth.mosdepth.summary.txt:NODE_21382_length_87_cov_28.300000	87	201	2.31	0	3

samtools idxstats
The output is TAB-delimited with each line consisting of reference sequence name, sequence length, # mapped read-segments and # unmapped read-segments. It is written to stdout. Note this may count reads multiple times if they are mapped more than once or in multiple fragments.

These are our candidate fish though
600232, 901522, 901232, 120092
400281, 401261, 500131, 701331

```{sh, eval=FALSE}
samtools view -q 10 120092-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "120092",$1,$2,$3,$4}' > 120092-sort.stats
samtools view -q 10 600232-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "600232",$1,$2,$3,$4}' > 600232-sort.stats
samtools view -q 10 901522-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "901522",$1,$2,$3,$4}' > 901522-sort.stats
samtools view -q 10 901232-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "901232",$1,$2,$3,$4}' > 901232-sort.stats

samtools view -q 10 400281-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "400281",$1,$2,$3,$4}' > 400281-sort.stats
samtools view -q 10 401261-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "401261",$1,$2,$3,$4}' > 401261-sort.stats
samtools view -q 10 500131-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "500131",$1,$2,$3,$4}' > 500131-sort.stats
samtools view -q 10 701331-realign.sort.bam -b| samtools idxstats - | grep -v "*" | awk '{print "701331",$1,$2,$3,$4}' > 701331-sort.stats


```
(base) maccamp@farm:~/longfin-histories/data/male-flash$ grep NODE_21382_length_87_cov_28.300000 *sort.stats
120092-sort.stats:120092 NODE_21382_length_87_cov_28.300000 87 2 0
400281-sort.stats:400281 NODE_21382_length_87_cov_28.300000 87 0 0
401261-sort.stats:401261 NODE_21382_length_87_cov_28.300000 87 0 0
500131-sort.stats:500131 NODE_21382_length_87_cov_28.300000 87 0 0
600232-sort.stats:600232 NODE_21382_length_87_cov_28.300000 87 1 0
701331-sort.stats:701331 NODE_21382_length_87_cov_28.300000 87 0 0
901232-sort.stats:901232 NODE_21382_length_87_cov_28.300000 87 1 0
901522-sort.stats:901522 NODE_21382_length_87_cov_28.300000 87 4 0

NODE_116_length_6410_cov_5.418759



# I can also use dapc to separate sexes and see what genome-wide markers there are 
