---
title: "207-delta-smelt"
output: html_document
date: "2025-07-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```


```{r}
library(tidyverse)
library(snpR)
library(adegenet)
library(vcfR)
library(RColorBrewer)
library(ggrepel)
```


Need to convert .sorted.bam to fastqs


Using the test80.bamlist in dsm-omics/test80.bamlist, also test80.pheno:
1 /home/maccamp/dsm-omics/data/SOMM516/121922_R1.sort.flt.bam
1 /home/maccamp/dsm-omics/data/SOMM516/401432_R1.sort.flt.bam
1 /home/maccamp/dsm-omics/data/SOMM516/402282_R1.sort.flt.bam
1 /home/maccamp/dsm-omics/data/SOMM516/500742_R1.sort.flt.bam
0 /home/maccamp/dsm-omics/data/SOMM516/130081_R1.sort.flt.bam etc.
0 Sex is based on the sample name.

(base) maccamp@farm:~/dsm-omics/data/fastq$ cat ../../bamlists/test80.bamlist | perl -pe 's/.flt//g'  | while read line; do ln -s $line ./ ; done;
mv fastq to /home/maccamp/longfin-histories/data/fastq

Need to convert to fastqs

```{sh, eval=FALSE}
 ls | grep .bam | perl -pe 's/_R1.sort.bam//g'  > samples.txt
 # this is going to take forever!! Hahahah
 cat samples.txt | while read line; do samtools fastq "$line"_R1.sort.bam -n -1 $line-R1.fastq.gz -2 $line-R2.fastq.gz -0 /dev/null -s /dev/null ; done; # doesn't work because the files were sorted. Sigh.

```


Retrieving from barbera, and that is still extant!
```{sh, eval=FALSE}
~/data/delta-smelt-omics$ scp -r maccampbell@barbera.genomecenter.ucdavis.edu:/share/schreierlab/smelt-wgs/demulti* ./ 
```

Need some meta, several of these fish are sexed based on prefixes. Previously I used an 80 bamlist. 
Symlink to data/dsm subdir those with sex info
e.g. 111392

104 samples


bash ../../101.2-do-align.sh to-align.txt /home/maccamp/genomes/longfin-polished/lfs_run3_scaffolds_final.fa


 have some aligned, lets take a look:
 
```{r}
dm<-read_csv("meta/test-dsm.csv", col_names = c("Sample","Aligned","Dedup","Coverage"))
dm$Sex<-gsub("^\\d\\d\\d\\d\\d","",dm$Sample)
dm$Sex<-as.numeric(dm$Sex)
dm<-dm %>% mutate(Path=paste0("/home/maccamp/longfin-histories/data/dsm/",Sample,".sort.flt.bam"))
```
 
 
```{r}
ggplot(dm) +
  geom_histogram(aes(x=Coverage))
```


```{r}
dm8<-dm %>% filter(Coverage>8) %>% mutate(Pheno=Sex-1)
dm8 %>% group_by(Sex) %>% summarize(Count=n())
```

#Run GWAS across chroms

```{r}
dm8 %>% select(Path) %>% write_tsv("bamlists/dm8.bamlist", col_names = FALSE)
dm8 %>% select(Pheno) %>% write_tsv("bamlists/dm8.pheno", col_names = FALSE)
```

dsm-omics/1300-do-asso.sh is really basic
editing to deal with lcl| in file names, now in 207.1-do-asso.sh

```{sh, eval=FALSE}
bash $HOME/longfin-histories/207.1-do-asso.sh $HOME/longfin-histories/bamlists/dm8.bamlist  $HOME/genomes/longfin-polished/1mbseqs.txt $HOME/longfin-histories/bamlists/dm8.pheno
```

Get long seqs
maccamp@farm:~/genomes/longfin-polished$ cat lfs_run3_scaffolds_final.fa.fai | awk '$2 > 1000000 {print;}' | cut -f 1 > 1mbseqs.txt


Plot

```{r}
files = list.files(path="outputs/207/", pattern="*.lrt0.gz", full.names = TRUE)
list = lapply(files, read_tsv)
data<-bind_rows(list)
```
```{r}
df <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p>=0 & log10p != "Inf") %>%
  mutate(p = dchisq(LRT, df=1)) %>%
  mutate(bonfer = p.adjust(p, method = "bonferroni")) %>% 
  mutate(BHfdr = p.adjust(p, method = "BH")) %>%
  group_by(Chromosome) %>%
  mutate(adjpchrom = p.adjust(p, method = "bonferroni")) %>%
  mutate(BHfdrchrom = p.adjust(p, method = "BH")) %>% ungroup() %>%
  mutate(Index=1:n())

df %>% arrange(-LRT) %>% head(n=20)
```
```{r}
nb.cols <- length(unique(df$Chromosome))
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)
#randomize
mycolors<-sample(mycolors)
```

```{r}
ggplot(df %>% filter(log10p>1)) +
  geom_point(aes(x=Position, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
#  geom_hline(yintercept= 8, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("DSM Sex GWAS with LFS Genome") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
  facet_wrap(.~Chromosome, ncol=5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

ggsave("outputs/207/dsm-lfs-gwas.jpeg", width=18, height=12)
```

```{r}
ggplot(df %>% filter(log10p>1)) +
  geom_point(aes(x=Index, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
#  geom_hline(yintercept= 8, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("DSM Sex GWAS with LFS Genome") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
 # facet_wrap(.~Chromosome, ncol=5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
ggsave("outputs/207/dsm-lfs-manhattan.jpeg", width=12, height=6)

```

### Call snps across lg13

Region:
```{r}
mins<-df %>% filter(Chromosome=="lcl|scaffold_13") %>% arrange(-LRT) %>% head(n=20) 
max(mins$Position)
min(mins$Position)
mins 
mins %>% select(Chromosome, Position) %>% write_tsv(file="meta/topgwas-sites.txt", col_names = FALSE)
```

We would expect the Minor Frequency to about .25 if 50:50, we have 31:23 so:

X chrom 0.79
Y chrom 0.21

Let's call the top20
54 inds 90% ~49

```{sh, eval=FALSE}
srun -t 2:00:00 -p high --mem=32G --nodes=1 --ntasks-per-node=1 --cpus-per-task=12 $HOME/angsd/angsd -nthreads 12 \
-minInd 18 -bam bamlists/yak.bamlist -ref /home/maccamp/genomes/longfin-polished/lfs_run3_scaffolds_final.fa \
-out outputs/207/top-scaffold13-snps -sites outputs/207/topgwas-sites.txt \
-minMaf 0.05 -minMapQ 10 -minQ 20 -GL 1 -doMajorMinor 1 -doMaf 1 -SNP_pval 1e-6 \
-doGeno 2 -doPost 1 -postCutoff 0.9 -doPlink 2  > outputs/207/snps.out 2> outputs/207/snps.err &
```

```{sh}
angsd sites index outputs/207/topgwas-sites.txt
```


## Model2

```{r}
files = list.files(path="outputs/207/model2/", pattern="*.lrt0.gz", full.names = TRUE)
list = lapply(files, read_tsv)
data<-bind_rows(list)
df <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p>=0 & log10p != "Inf") %>%
  mutate(p = dchisq(LRT, df=1)) %>%
  mutate(bonfer = p.adjust(p, method = "bonferroni")) %>% 
  mutate(BHfdr = p.adjust(p, method = "BH")) %>%
  group_by(Chromosome) %>%
  mutate(adjpchrom = p.adjust(p, method = "bonferroni")) %>%
  mutate(BHfdrchrom = p.adjust(p, method = "BH")) %>% ungroup() %>%
  mutate(Index=1:n())

df %>% arrange(-LRT) %>% head(n=20)
```

```{r}
ggplot(df %>% filter(log10p>1)) +
  geom_point(aes(x=Position, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
#  geom_hline(yintercept= 8, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("DSM Sex GWAS with LFS Genome") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
  facet_wrap(.~Chromosome, ncol=5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

ggsave("outputs/207/dsm-lfs-gwas-model2.jpeg", width=18, height=12)
```

```{r}
ggplot(df %>% filter(log10p>1)) +
  geom_point(aes(x=Index, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
 # geom_hline(yintercept = -log10(0.05/nrow(dddf)), col="black", linetype=2, alpha=0.5) +
#  geom_hline(yintercept= 8, col="black", linetype=1, alpha=0.5) +
  theme_bw() +
#  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=8)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)\n") +
  xlab("\nChromosome") +
  ggtitle("DSM Sex GWAS with LFS Genome") +
  theme(plot.title = element_text(hjust=0.5) ) +
  theme(plot.subtitle = element_text(hjust=0.5)) +
 # facet_wrap(.~Chromosome, ncol=5, scales="free_x") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
ggsave("outputs/207/dsm-lfs-manhattan-model2.jpeg", width=12, height=6)

```

